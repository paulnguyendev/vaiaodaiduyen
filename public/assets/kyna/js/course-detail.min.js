"use strict";

var curPageReview = 0,
    course_detail = {
        handleStickyPriceMobile: function () {
            var e = $(".course-detail--right .crs-btn"),
                t = $(".wrap-box-price"),
                a = $(e).offset().top;
            $(window).width() <= 1200 &&
                $(document).scroll(function () {
                    $(document).scrollTop() > a + 50
                        ? ($(t).addClass("show"),
                          $("body").addClass("price-box-fixed"))
                        : ($(t).removeClass("show"),
                          $("body").removeClass("price-box-fixed"));
                });
        },
        handleStickyPosition: function () {
            var e = $(".cd-sticky-info.opt-1"),
                t = $(".crs-sticky-info.opt-1"),
                a = $(".cd-top-banner").outerHeight(),
                o = $(e).outerHeight(),
                i = $(t).outerHeight();
            $(window).width() > 1199 &&
                a > 520 &&
                ($(e).css({ "margin-top": -o - 165, "margin-bottom": i + 24 }),
                $(t).css("margin-top", -148));
        },
        handleStickyStyle: function () {
            var e = $(".cd-sticky-info"),
                t = $(e).offset().top;
            $(window).scroll(function () {
                $(e).offset().top > t + 50
                    ? $(e).addClass("default-style")
                    : $(e).removeClass("default-style");
            });
        },
        handleStickyHeader: function () {
            $(window).width() >= 768 &&
                ($(document).scrollTop() > 573
                    ? $(".course-header-sticky").addClass("show")
                    : $(".course-header-sticky").addClass("hide"),
                $(document).on("scroll", function (e) {
                    $(document).scrollTop() > 573
                        ? ($(".course-header-sticky").removeClass("hide"),
                          $(".course-header-sticky").addClass("show"))
                        : ($(".course-header-sticky").removeClass("show"),
                          $(".course-header-sticky").addClass("hide"));
                }));
        },
        readMore: function (e, t, a) {
            var o = $(".".concat(t)),
                i = $(".data-hidden").data("cdn-url");
            o.each(function (t, o) {
                var s = $(o).outerHeight();
                s > e &&
                    $(o)
                        .closest(".".concat(a))
                        .append(
                            '<a href="#" class="cta__readmore">Xem thĂªm <img src="'.concat(
                                i,
                                '/img/arrow-green.svg" alt="Kyna" width="20px" height="20px"></a>'
                            )
                        ),
                    $(o).attr("data-max-height", s),
                    $(o).animate({ maxHeight: e });
            }),
                $(".".concat(a, " .cta__readmore")).on("click", function (a) {
                    if (
                        (a.preventDefault(),
                        $(this).hasClass("cta__readmore--close"))
                    ) {
                        $(this).toggleClass("cta__readmore--close"),
                            $(this).html(
                                'Xem thĂªm <img src="'.concat(
                                    i,
                                    '/img/arrow-green.svg" alt="Kyna" width="20px" height="20px">'
                                )
                            ),
                            $(this).css({ bottom: 0 });
                        var o = $(this).closest(".course-general").offset().top;
                        $("html,body").animate({ scrollTop: o - 60 }, 500),
                            $(this)
                                .siblings(".".concat(t))
                                .animate({ maxHeight: e });
                    } else {
                        $(this).addClass("cta__readmore--close"),
                            $(this).html(
                                'Thu gá»n <img src="'.concat(
                                    i,
                                    '/img/arrow-green.svg" alt="Kyna" width="20px" height="20px" style="transform: scale(-1)"></i>'
                                )
                            );
                        var s = $(this)
                            .siblings(".".concat(t))
                            .attr("data-max-height");
                        $(this).css({ bottom: -30 }),
                            $(this)
                                .siblings(".".concat(t))
                                .animate({ maxHeight: s });
                    }
                });
        },
        handleReadMoreElement: function () {
            this.readMore(300, "course-general__wrapper", "course-general");
        },
        initPlayer: function () {
            var e = $(".video-preview__playlist-item")
                .first()
                .attr("data-source");
            $(".cta-open-video").first().addClass("playing");
            var t = videojs("video-preview__player");
            videojs("video-preview__player", {
                controls: !0,
                autoplay: !0,
                preload: "metadata",
            }),
                t.src(e);
        },
        handleVideo: function () {
            $(".video-preview__video").each(function (e, t) {
                var a = $(t).find(".cta-open-video");
                a.length < 1 ||
                    (a.attr("data-source").search("mp4") < 0 && $(t).hide());
            });
            var e = videojs("video-preview__player");
            $(".video-preview__playlist-item").on("click", function (t) {
                t.preventDefault(),
                    $(".video-preview__playlist-item").each(function (e, t) {
                        $(t).removeClass("playing");
                    }),
                    $(this).addClass("playing");
                var a = $(this).attr("data-source");
                e.src(a), e.play();
            }),
                $(".cta-open-video").on("click", function (t) {
                    t.preventDefault(),
                        $(".video-preview__video").each(function (e, t) {
                            $(t).removeClass("playing");
                        }),
                        $(this)
                            .closest(".video-preview__video")
                            .addClass("playing");
                    var t = $(this).attr("data-source");

                    $("#video-modal").modal("show");
                    $(".video-preview__wrapper iframe").attr("src", t);
                }),
                $("#video-modal").on("shown.bs.modal", function (t) {
                    e.play();
                }),
                $("#video-modal").on("hidden.bs.modal", function (t) {
                    e.pause();
                    $(".video-preview__wrapper iframe").attr("src", "");
                });
        },
        storeUserSeenCourse: function () {
            var e = JSON.parse(localStorage.getItem("userSeenCoursesV4")),
                t = $(".data-hidden"),
                a = {
                    id: t.data("id"),
                    name: t.data("name"),
                    slug: t.data("slug"),
                    teacher_name:
                        "" != t.data("teacher_name")
                            ? t.data("teacher_name")
                            : "N/A",
                    teacher_title:
                        "" != t.data("teacher_title")
                            ? t.data("teacher_title")
                            : "N/A",
                    teacher_avatar:
                        "" != t.data("teacher_avatar")
                            ? t.data("teacher_avatar")
                            : "",
                    image_url: t.data("image_url"),
                    total_lesson: t.data("total_lesson"),
                    rating: t.data("rating"),
                    sale_price: t.data("sale_price"),
                    origin_price: t.data("origin_price"),
                    review_lesson: t.data("review_lesson"),
                    type: t.data("type"),
                    uploadDate: t.data("upload-date"),
                    duration: t.data("duration"),
                    userEnroll: t.data("user-enroll"),
                    description: t.data("description"),
                    promoText: t.data("promo-text"),
                    isBestSeller: t.data("is-best-seller"),
                    isWow: t.data("is-wow"),
                    statusItem: t.data("status-item"),
                };
            (null == e ||
                (!e.some(function (e) {
                    return e.name === a.name;
                }) &&
                    a.sale_price > 0)) &&
                (null !== e
                    ? (e.unshift(a), e.length > 4 && e.pop())
                    : (e = []).unshift(a),
                localStorage.setItem("userSeenCoursesV4", JSON.stringify(e)));
        },
        handleTabsFixed: function () {
            var e = $("#courseDetailTabs"),
                t = $("#courseDetailIntro");
            if (e.length) {
                var a = $("body"),
                    o = 0;
                (o =
                    $(window).width() > 1199 ? e.offset().top : t.offset().top),
                    $(document).on("scroll", function (e) {
                        $(this).scrollTop() > o
                            ? a.addClass("tabs-fixed")
                            : a.removeClass("tabs-fixed");
                    });
            }
        },
        handleScrollSmooth: function () {
            $(".course-detail-tab").on("click", function (e) {
                if (
                    location.pathname.replace(/^\//, "") ==
                        this.pathname.replace(/^\//, "") &&
                    location.hostname == this.hostname
                ) {
                    var t = $(this.hash);
                    (t = t.length ? t : $("[name=" + this.hash.slice(1) + "]"))
                        .length &&
                        (e.preventDefault(),
                        $("html,body").animate(
                            { scrollTop: t.offset().top - 60 },
                            1e3
                        ));
                }
            });
        },
        _handleReadMoreReview: function () {
            $(".course-comment-item__quote").each(function () {
                var e = $(this).text();
                if (!((e = e.match(/[^ ]+/g)).length < 70)) {
                    var t = "<span>"
                        .concat(
                            e.slice(0, 70).join(" "),
                            '</span>\n                                    <a class="cmt-readmore-cta"><span class="dots">...</span> Xem thĂªm</a>\n                                    <span class="cmt-readmore-hide">'
                        )
                        .concat(e.slice(70).join(" "), "</span>");
                    $(this).html(t);
                }
            }),
                $(document).on("click", ".cmt-readmore-cta", function (e) {
                    e.preventDefault(),
                        $(this).hide(),
                        $(this).find("~ .cmt-readmore-hide").show();
                });
        },
        loadReview: function () {
            var e = $(".course-comment"),
                t = $("#loadReviewUrl").text();
            curPageReview++,
                $.ajax({
                    method: "get",
                    url: t,
                    data: { page: curPageReview },
                    success: function (t) {
                        e.find(".button-more").remove(),
                            e.append(t),
                            course_detail._handleReadMoreReview();
                    },
                });
        },
        handleClickReviewLoadMore: function () {
            $(".course-comment").on("click", ".button-more", function (e) {
                e.preventDefault(),
                    $("#review .button-more img.loading-review").show(),
                    $("#review .button-more button").hide(),
                    course_detail.loadReview();
            });
        },
        handleConsultForm: function () {
            var e = $("#k-popup-course-advisor");
            $(document).on("submit", "#course-advisor-form", function (t) {
                t.preventDefault();
                var a = $("#consultFormNotification"),
                    o = $("#course-advisor-form").serializeArray();
                $.ajax({
                    method: "post",
                    url: "/course/course-advisor/view",
                    data: o,
                    beforeSend: function () {
                        e.find("input, textarea").each(function () {
                            $(this).addClass("disabled");
                        });
                    },
                })
                    .done(function (t) {
                        t.result
                            ? (a.html(
                                  '<span class="box success">Gá»­i thĂ´ng tin thĂ nh cĂ´ng.\n                                            ChĂºng tĂ´i sáº½ liĂªn há»‡ vá»›i báº¡n sá»›m!</span>'
                              ),
                              setTimeout(function () {
                                  $("#k-popup-course-advisor").modal("hide");
                              }, 5e3))
                            : (a.html(
                                  '<span class="box error">'.concat(
                                      t.errors[Object.keys(t.errors)[0]][0],
                                      "</span>"
                                  )
                              ),
                              e.find("input, textarea").each(function () {
                                  $(this).removeClass("disabled");
                              }));
                    })
                    .fail(function () {
                        a.html(
                            '<span class="box error">CĂ³ lá»—i xáº£y ra. Vui lĂ²ng liĂªn há»‡ bá»™ pháº­n há»— trá»£ khĂ¡ch hĂ ng.</span>'
                        ),
                            e.find("input, textarea").each(function () {
                                $(this).removeClass("disabled");
                            });
                    })
                    .always(function () {});
            }),
                e.on("hide.bs.modal", function () {
                    e.html("");
                });
        },
        addGAToCourseDetail: function () {
            var e = window.location.search,
                t = $(".crs-btn-call"),
                a = $("#btn-goto-cart");
            (e = e || "?utm_source=course_detail"),
                $(".related-course__wrapper .card-link").each(function () {
                    $(this).attr(
                        "href",
                        $(this)
                            .attr("href")
                            .concat(e, "&utm_medium=related_course")
                    );
                }),
                t.attr("href", t.attr("href").concat(e, "&utm_medium=advisor")),
                a.attr(
                    "href",
                    a.attr("href").concat(e, "&utm_medium=view_cart")
                );
        },
        init: function () {
            this.handleStickyPriceMobile(),
                this.handleStickyPosition(),
                this.handleStickyStyle(),
                this.handleReadMoreElement(),
                this.initPlayer(),
                this.handleVideo(),
                this.handleStickyHeader(),
                this.storeUserSeenCourse(),
                this.handleTabsFixed(),
                this.handleScrollSmooth(),
                this.loadReview(),
                this.handleClickReviewLoadMore(),
                this.handleConsultForm(),
                this.addGAToCourseDetail();
        },
    };
$(document).ready(function () {
    course_detail.init(),
        $(".add-to-cart").click(function () {
            $(this).hide(), $("#btn-goto-cart").show();
        });
});
